{% extends 'base-admin.html' %}
{% block title %}Tạo bài kiểm tra{% endblock %}
{% block content %}
<style>
  .container {
    max-width: 100%;
    padding: 1rem 2rem;
  }

  h2.custom-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #5c6bc0;
    border-bottom: 2px solid #5c6bc0;
    margin-bottom: 2rem;
    padding-bottom: 0.5rem;
  }

  .card {
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border: 1px solid #e3e3e3;
    border-radius: 8px;
  }

  .card-header {
    font-weight: 600;
    font-size: 1.1rem;
  }

  .question-item {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
    position: relative;
  }

  .question-item h5 {
    font-weight: 600;
    color: #0d6efd;
    margin-bottom: 15px;
  }

  .media-section {
    background-color: #eef5ff;
    padding: 1rem;
    border-left: 4px solid #0d6efd;
    margin-top: 1rem;
    border-radius: 5px;
  }

  .remove-btn {
    position: absolute;
    top: 10px;
    right: 10px;
  }

  .btn-outline-primary {
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 6px;
  }

  textarea.form-control {
    resize: vertical;
  }

  .form-control, .form-label {
    font-size: 0.95rem;
  }
</style>

<div class="container">
  <h2 class="custom-title">Tạo Bài Kiểm Tra</h2>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Thông tin bài kiểm tra -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Thông tin bài kiểm tra</div>
      <div class="card-body">
        {{ test_form.as_p }}
      </div>
    </div>

    <!-- Danh sách câu hỏi -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">Danh sách câu hỏi</div>
      <div class="card-body" id="question-formset"></div>

      <!-- Hidden fields cho formset -->
      <input type="hidden" name="form-TOTAL_FORMS" id="id_form-TOTAL_FORMS" value="1">
      <input type="hidden" name="form-INITIAL_FORMS" value="0">
      <input type="hidden" name="form-MIN_NUM_FORMS" value="0">
      <input type="hidden" name="form-MAX_NUM_FORMS" value="1000">

      <div class="px-3 pb-3">
        <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">+ Thêm câu hỏi</button>
      </div>
    </div>

    <button type="submit" class="btn btn-danger">Lưu bài kiểm tra</button>
  </form>
</div>

<!-- Template ẩn -->
<div id="question-template" style="display: none;">
  <div class="question-item">
    <h5>Câu __INDEX__</h5>
    <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeQuestion(this)">Xóa câu hỏi</button>

    <label>Câu hỏi:</label>
    <textarea name="form-__INDEX__-question_text" class="form-control mb-2" rows="2"></textarea>

    <div class="row">
      <div class="col-md-6">
        <label>Đáp án A:</label>
        <input type="text" name="form-__INDEX__-answer_a" class="form-control mb-2">
      </div>
      <div class="col-md-6">
        <label>Đáp án B:</label>
        <input type="text" name="form-__INDEX__-answer_b" class="form-control mb-2">
      </div>
      <div class="col-md-6">
        <label>Đáp án C:</label>
        <input type="text" name="form-__INDEX__-answer_c" class="form-control mb-2">
      </div>
      <div class="col-md-6">
        <label>Đáp án D:</label>
        <input type="text" name="form-__INDEX__-answer_d" class="form-control mb-2">
      </div>
    </div>

    <label>Đáp án đúng:</label>
    <select name="form-__INDEX__-correct_answer" class="form-select mb-3" required>
      <option value="">-- Chọn đáp án đúng --</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
    </select>


    <div class="media-section">
      <label>Audio (nếu có):</label>
      <input type="file" name="form-__INDEX__-audio_file" class="form-control mb-2">
      <label>Đoạn văn (nếu có):</label>
      <textarea name="form-__INDEX__-paragraph" class="form-control" rows="2"></textarea>
    </div>
  </div>
</div>

<!-- Script -->
<script>
let totalForms = 0;

function addQuestion() {
  const container = document.getElementById('question-formset');
  const template = document.getElementById('question-template').innerHTML.replace(/__INDEX__/g, totalForms);
  const wrapper = document.createElement('div');
  wrapper.innerHTML = template;
  container.appendChild(wrapper);
  totalForms++;
  document.getElementById('id_form-TOTAL_FORMS').value = totalForms;
  updateQuestionNumbers();
}

function removeQuestion(button) {
  const item = button.closest('.question-item');
  item.remove();
  totalForms = document.querySelectorAll('.question-item').length;
  document.getElementById('id_form-TOTAL_FORMS').value = totalForms;
  updateQuestionNumbers();
}

function updateQuestionNumbers() {
  document.querySelectorAll('.question-item h5').forEach((el, idx) => {
    el.textContent = `Câu ${idx + 1}`;
  });
}

// Tự thêm 1 form đầu tiên khi load trang
window.onload = () => {
  if (totalForms === 0) addQuestion();
}
</script>
{% endblock %}
