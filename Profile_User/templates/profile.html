{% extends 'base.html' %}
{% load static %}
{% load form_filters %}
{% block title %}Quản Lý Thông Tin Cá Nhân{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    padding-top: 60px !important;

  }
    .sidebar-fixed {
    position: fixed;
    top: 80px; /* bằng chiều cao của navbar/header */
    left: 0;
    width: 260px; /* hoặc 100% nếu trên mobile */
    height: calc(100vh - 80px);
    overflow-y: auto;
    background-color: white;
    border-right: 1px solid #ddd;
    padding: 20px;
    z-index: 1000;
  }

  .content-fixed {
    margin-left: 260px; /* bằng với sidebar width */
  }

  .tab-content {
    align-items: unset !important;
    justify-content: unset !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
</style>
</style>
<div class="container py-5" >
  <div class="row">
    <div class="col-md-3 sidebar-fixed" >
      <div class="text-center mb-4">
        <div class="rounded-circle overflow-hidden border border-3" style="width: 120px; height: 120px; margin: auto;">
          {% if user.profile.image %}
            <img src="{{ user.profile.image.url }}" alt="Avatar" class="img-fluid h-100 w-100 object-fit-cover">
          {% else %}
            <img src="{% static 'images/default-avatar.png' %}" alt="Avatar" class="img-fluid h-100 w-100 object-fit-cover">
          {% endif %}
        </div>
        <h5 class="mt-3">{{ user.get_full_name }}</h5>
      </div>
      <div class="list-group">
        <button type="button" class="list-group-item list-group-item-action {% if active_tab == 'personal-info' %}active{% endif %}" data-tab="personal-info">Thông tin cá nhân</button>
        <button type="button" class="list-group-item list-group-item-action {% if active_tab == 'password' %}active{% endif %}" data-tab="password">Mật khẩu</button>
        <button type="button" class="list-group-item list-group-item-action {% if active_tab == 'email' %}active{% endif %}" data-tab="email">Email</button>
        <button type="button" class="list-group-item list-group-item-action {% if active_tab == 'classes' %}active{% endif %}" data-tab="classes">Lớp học của tôi</button>
      </div>
    </div>

    <div class="col-md-9 content-fixed">
      <!-- Personal Info -->
      <div class="tab-content {% if active_tab == 'personal-info' %}active{% endif %}" id="personal-info">
        <h4>Thông tin cá nhân</h4>
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="personal-info-submit" value="1">

          <div class="row mb-3">
            <div class="col">
              <label class="form-label">Họ và tên đệm</label>
              <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}">
            </div>
            <div class="col">
              <label class="form-label">Tên</label>
              <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col">
              <label class="form-label">Ngày sinh</label>
              {{ profile_form.dob|add_class:"form-control" }}
            </div>
            <div class="col">
              <label class="form-label">Giới tính</label>
              {{ profile_form.sex|add_class:"form-select" }}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Mô tả</label>
            {{ profile_form.description|add_class:"form-control" }}
          </div>

          <div class="mb-3">
  <label class="form-label">Ảnh đại diện</label>
  <div class="d-flex align-items-center gap-4">
    <div style="width: 120px; height: 120px;">
      {% if user.profile.image %}
        <img src="{{ user.profile.image.url }}" alt="Avatar" class="img-thumbnail" style="width: 100%; height: 100%; object-fit: cover;">
      {% else %}
        <img src="{% static 'images/default-avatar.png' %}" alt="Avatar" class="img-thumbnail" style="width: 100%; height: 100%; object-fit: cover;">
      {% endif %}
    </div>
    <div class="flex-grow-1">
      {{ profile_form.image|add_class:"form-control" }}
    </div>
  </div>
</div>

          <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
        </form>
      </div>

      <!-- Password Change -->
      <div class="tab-content {% if active_tab == 'password' %}active{% endif %}" id="password" style="display: none;">
        <h4>Đổi mật khẩu</h4>
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="password-submit" value="1">

          <div class="mb-3">
            <label class="form-label">Mật khẩu hiện tại</label>
            {{ password_form.old_password|add_class:"form-control" }}
            {% if password_form.old_password.errors %}
              <div class="text-danger small">{{ password_form.old_password.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Mật khẩu mới</label>
            {{ password_form.new_password1|add_class:"form-control" }}
            {% if password_form.new_password1.errors %}
              <div class="text-danger small">{{ password_form.new_password1.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Xác nhận mật khẩu mới</label>
            {{ password_form.new_password2|add_class:"form-control" }}
            {% if password_form.new_password2.errors %}
              <div class="text-danger small">{{ password_form.new_password2.errors.0 }}</div>
            {% endif %}
          </div>

          <button type="submit" class="btn btn-warning">Đổi mật khẩu</button>
        </form>
      </div>

      <!-- Email Update -->
      <div class="tab-content {% if active_tab == 'email' %}active{% endif %}" id="email" style="display: none;">
        <h4>Thay đổi email</h4>
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="email-submit" value="1">

          <div class="mb-3">
            <label class="form-label">Email hiện tại</label>
            <input type="email" value="{{ user.email }}" class="form-control" disabled>
          </div>

          <div class="mb-3">
            <label class="form-label">Email mới</label>
            {{ email_form.email|add_class:"form-control" }}
            {% if email_form.email.errors %}
              <div class="text-danger small">{{ email_form.email.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Mã xác nhận</label>
            {{ email_form.verification_code|add_class:"form-control" }}
            {% if email_form.verification_code.errors %}
              <div class="text-danger small">{{ email_form.verification_code.errors.0 }}</div>
            {% endif %}
          </div>

          <button type="submit" class="btn btn-success">Cập nhật email</button>
        </form>
      </div>

      <!-- Enrolled Classes -->
      <div class="tab-content {% if active_tab == 'classes' %}active{% endif %}" id="classes" style="display: none;">
        <h4>Lớp học đã đăng ký</h4>
        {% if enrolled_classes %}
          <ul class="list-group">
            {% for c in enrolled_classes %}
              <li class="list-group-item">{{ c.class_name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>Bạn chưa đăng ký lớp nào.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const navItems = document.querySelectorAll(".list-group-item");
  const tabContents = document.querySelectorAll(".tab-content");

  navItems.forEach((item) => {
    item.addEventListener("click", function () {
      const tabId = this.getAttribute("data-tab");
      localStorage.setItem("activeTab", tabId);

      tabContents.forEach((tab) => {
        tab.classList.remove("active");
        tab.style.display = "none";
      });
      navItems.forEach((btn) => btn.classList.remove("active"));

      this.classList.add("active");
      const activeTab = document.getElementById(tabId);
      if (activeTab) {
        activeTab.classList.add("active");
        activeTab.style.display = "block";
      }
    });
  });

  const savedTab = localStorage.getItem("activeTab");
  if (savedTab) {
    const trigger = document.querySelector(`.list-group-item[data-tab="${savedTab}"]`);
    if (trigger) trigger.click();
  }
});
</script>
{% endblock %}
{% block footer %}

{% endblock %}